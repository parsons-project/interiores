package interiores.presentation.swing.views;

import interiores.business.events.room.RoomCreatedEvent;
import interiores.business.events.room.RoomDesignFinishedEvent;
import interiores.business.events.room.RoomDesignStartedEvent;
import interiores.business.events.room.RoomLoadedEvent;
import interiores.business.models.OrientedRectangle;
import interiores.business.models.backtracking.FurnitureValue;
import interiores.core.Debug;
import interiores.core.presentation.SwingController;
import interiores.core.presentation.annotation.Listen;
import interiores.presentation.swing.views.map.RoomMap;
import interiores.presentation.swing.views.map.RoomMapDebugger;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.util.Map.Entry;
import javax.swing.JPanel;

/**
 *
 * @author hector
 */
public class RoomMapPanel extends JPanel
{
    private RoomMap map;
    private RoomMapDebuggerFrame debuggerGui;

    /**
     * Creates new form RoomMap
     */
    public RoomMapPanel(SwingController presentation) throws Exception
    {
        initComponents();
                
        map = null;
        
        if(Debug.isEnabled())
            debuggerGui = presentation.get(RoomMapDebuggerFrame.class);
    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this
     * code. The content of this method is always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents()
    {

        setLayout(null);
    }// </editor-fold>//GEN-END:initComponents
    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables

    @Override
    public void paintComponent(Graphics g)
    {
        if(map != null) {
            Graphics2D g2d = (Graphics2D) g;
            map.draw(g2d);
        }
    }
    
    public RoomMap getRoomMap() {
        return map;
    }
    
    @Listen({RoomCreatedEvent.class, RoomLoadedEvent.class})
    public void createMap(RoomCreatedEvent event)
    {
        int width = event.getWidth();
        int depth = event.getDepth();
        
        if(Debug.isEnabled()) {
            map = new RoomMapDebugger(width, depth); // Debug mode! Let's load a debuggable map!
            debuggerGui.setDebuggee(this);
        }
        else
            map = new RoomMap(width, depth); // A simple room map on production
        
        setPreferredSize(new Dimension(map.getWidth(), map.getHeight()));
        repaint();
    }
      
    @Listen(RoomDesignStartedEvent.class)
    public void putSearching() {
        map.setStatus("Searching...");
        
        repaint();
    }
    
    @Listen(RoomDesignFinishedEvent.class)
    public void updateDesign(RoomDesignFinishedEvent event) {
        if (event.hasDesign())
        {
            map.clearFurniture();
            
            map.setStatus("Solution found! :)");
        
            for(Entry<String, FurnitureValue> entry : event.getDesign()) {
                String name = entry.getKey();
                Color color = entry.getValue().getModel().getColor();

                addFurniture(name, entry.getValue().getArea(), color);
            }
        }
        else
            map.setStatus("Solution not found :(");
        
        if (event.hasTime())
            map.setTime(event.getTime());
        repaint();
    }
    
    public void addFurniture(String name, OrientedRectangle area, Color color) {
        map.addFurniture(name, area, color);
    }
}
